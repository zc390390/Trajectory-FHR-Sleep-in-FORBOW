---
title: "Trajectories"
author: "Zachary"
date: '2025-07-28'
output: html_document
---

# Library & Notes
```{r setup, include=FALSE}
library(haven); library(dplyr); library(tidyr); library(readr); library(readxl); library(data.table); library(stringr); library(purrr)  # Data manipulation & import
library(lme4); library(lmerTest); library(coxme); library(survival); library(broom); library(MuMIn); library(lsmeans)  # Modeling & statistics
library(pander); library(apaTables); library(flextable); library(officer); library(webshot2)  # Tables & reporting
library(ggplot2)  # Plotting
library(fuzzyjoin)  # Joins
library(survminer)
```

#Power Analysis
```{r}



```





#Analysis Begin

## Load Analytic & Sleep
```{r}
setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
# setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data/ESCAP") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git") # Home Computer

load("~/Code/Git/data/analytic-zach.RData")
Night <- read.csv("part4_nightsummary_sleep_cleaned.csv")
Day <- read.csv("part2_daysummary.csv")
```
### Actigraphy
## Check total valid amount of participants
```{r}
Day <- Day %>%
  mutate(ValidDay = ifelse(N.valid.hours >= 16, 1, 0)) 
Day <- Day %>%
  group_by(filename) %>%
  summarise(
    TotalValidWD = sum(ValidDay[weekday %in% c('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday')], na.rm = TRUE),
    TotalValidWE = sum(ValidDay[weekday %in% c('Saturday', 'Sunday')], na.rm = TRUE)
  )


DayF <- Day %>% filter(TotalValidWD >= 3 & TotalValidWE >= 1)
DayF$Subject_ID <- substr(DayF$filename, 1, 12)
DayF$Assessment_Date <- str_extract(DayF$filename, "\\d{4}-\\d{2}-\\d{2}")
DayFChild <- DayF %>% 
  filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))
DayFParent <- DayF %>% 
  filter(str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))

bin_files_to_remove <- c(
  "8000103174_left wrist_068158_2025-06-03 10-40-36.bin",
  "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin",
  "8000156273_left wrist_060381_2024-11-05 12-27-40.bin",
  "800304581_right wrist_060843_2024-11-05 13-16-09.bin",
  "800304582__060365_2024-11-05 12-03-44.bin",
  "800304582__060365_2024-11-05 12-28-01.bin"
)

DayFChild <- DayFChild %>%
  filter(!filename %in% bin_files_to_remove)
DayFChild <- DayFChild %>%
  mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))

DayFChild$Subject_ID <- gsub("-", "", DayFChild$Subject_ID)
DayFChild$Subject_ID <- gsub("[a-zA-Z]", "", DayFChild$Subject_ID)
DayFChild$Subject_ID <- gsub("_", "", DayFChild$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))
```

```{r}
setDT(DayFChild)
setDT(FOR)

DayFChild[, Assessment_Date := as.Date(Assessment_Date)]
FOR[, Assessment_Date := as.Date(assessment_date)]
#Perform a left join, retaining all rows in day4merge
##Performing merge, making day4days, but this only merges individuals who actually have a subject_ID and assessment_date
setorder(DayFChild, Subject_ID, Assessment_Date)
setorder(FOR, Subject_ID, Assessment_Date)
merged <- FOR[DayFChild, on = .(Subject_ID, Assessment_Date), roll = "nearest"]
unmerged <- FOR[!merged, on = .(Subject_ID, Assessment_Date), roll = "nearest"]

FORm <- rbind(unmerged, merged, fill = TRUE)  
```
