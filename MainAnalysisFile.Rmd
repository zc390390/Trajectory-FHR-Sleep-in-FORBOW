---
title: "Trajectories"
author: "Zachary"
date: '2025-07-28'
output: html_document
---

# Library & Notes
```{r setup, include=FALSE}
library(haven); library(dplyr); library(tidyr); library(readr); library(readxl); library(data.table); library(stringr); library(purrr)  # Data manipulation & import
library(lme4); library(lmerTest); library(coxme); library(survival); library(broom); library(MuMIn); library(lsmeans)  # Modeling & statistics
library(pander); library(apaTables); library(flextable); library(officer); library(webshot2)  # Tables & reporting
library(ggplot2)  # Plotting
library(fuzzyjoin)  # Joins
library(survminer)
library(hexbin)
library(lubridate)

```

#Power Analysis




#Graph

## Load Analytic & Sleep
```{r}
setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
# setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git") # Home Computer

load("analytic-zach.RData")
Night <- read.csv("part4_summary_sleep_cleaned.csv")
```
### Actigraphy
## Check total valid amount of participants
```{r}
Night <- Night %>% filter(n_WE_nights_complete >= 3 & n_WD_nights_complete >= 1)


Night$Subject_ID <- substr(Night$filename, 1, 12)
Night$Assessment_Date <- str_extract(Night$filename, "\\d{4}-\\d{2}-\\d{2}")
Night <- Night %>% 
  filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))


bin_files_to_remove <- c(
  "8000103174_left wrist_068158_2025-06-03 10-40-36.bin",
  "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin",
  "8000156273_left wrist_060381_2024-11-05 12-27-40.bin",
  "800304581_right wrist_060843_2024-11-05 13-16-09.bin",
  "800304582__060365_2024-11-05 12-03-44.bin",
  "800304582__060365_2024-11-05 12-28-01.bin"
)

Night <- Night %>%
  filter(!filename %in% bin_files_to_remove)
Night <- Night %>%
  mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))

Night$Subject_ID <- gsub("-", "", Night$Subject_ID)
Night$Subject_ID <- gsub("[a-zA-Z]", "", Night$Subject_ID)
Night$Subject_ID <- gsub("_", "", Night$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))
```

```{r}
setDT(Night)
setDT(FOR)

Night[, Assessment_Date := as.Date(Assessment_Date)]
FOR[, Assessment_Date := as.Date(assessment_date)]
#Perform a left join, retaining all rows in day4merge
##Performing merge, making day4days, but this only merges individuals who actually have a subject_ID and assessment_date
setorder(Night, Subject_ID, Assessment_Date)
setorder(FOR, Subject_ID, Assessment_Date)
merged <- FOR[Night, on = .(Subject_ID, Assessment_Date), roll = "nearest"]
```

#Mean Graphing
Used generalized additive model 
```{r}
merged$RoundAge <- round(merged$age)
merged$group <- factor(merged$group,
                       levels = c(0, 1, 2, 3),
                       labels = c("Control", "MDD Risk", "BD Risk", "Psy Risk"))
merged$sex <- factor(merged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
merged <- merged %>% filter(group != 3)
merged <- merged %>% 
  filter(!is.na(group))
merged %>%
  filter(group != 3)
```

##Sleep Regularity Index
```{r}
a_f_WD <- ggplot(data = merged, mapping = aes(x = age, y = SleepRegularityIndex1_WD_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") +  
    scale_y_continuous(
    limits = c(10, 90),
    breaks = seq(10, 90, by = 10)
  ) +
  labs(
    title = "Sleep Regularity Index Across Age by Group Weekdays (Faceted)",
    x = "Age",
    y = "Sleep Regularity Index",
    color = "Group"
  ) + facet_wrap(~ group)
a_f_WD

a_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = SleepRegularityIndex1_WE_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") +  
      scale_y_continuous(
    limits = c(10, 90),
    breaks = seq(10, 90, by = 10)
  ) +
  labs(
    title = "Sleep Regularity Index Across Age by Group Weekends (Faceted)",
    x = "Age",
    y = "Sleep Regularity Index",
    color = "Group"
  ) + facet_wrap(~ group) 
a_f_WE
```


##Time Spent Inactive During Sleep Window
```{r}
b_f_WD <- ggplot(data = merged, mapping = aes(x = RoundAge, y = SleepDurationInSpt_WD_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") + 
    scale_y_continuous(
    limits = c(5, 10),
    breaks = seq(5, 10, by = 1)
  ) +
  labs(
    title = "Sleep Duration Across Age by Group Weekdays (Faceted)",
    x = "Age",
    y = "Sleep Duration (Hours)",
    color = "Group"
  ) + facet_wrap(~ group)
b_f_WD

b_f_WE <- ggplot(data = merged, mapping = aes(x = RoundAge, y = SleepDurationInSpt_WE_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") + 
    scale_y_continuous(
    limits = c(5, 10),
    breaks = seq(5, 10, by = 1)
  ) +
  labs(
    title = "Sleep Duration Across Age by Group Weekends (Faceted)",
    x = "Age",
    y = "Sleep Duration (Hours)",
    color = "Group"
  ) + facet_wrap(~ group)
b_f_WE
```

##Total Sleep Window Time
```{r}
#WeekDay 
c_f_WD <- ggplot(data = merged, aes(x = RoundAge, y = SptDuration_WD_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") +
    scale_y_continuous(
    limits = c(6, 12)) + 
  labs(
    title = "Time in Bed and Age by Group Weekday (Faceted)",
    y = "Time in Bed",
    x = "Age",
    color = "Group"
  ) +
  facet_wrap(~ group)
c_f_WD

#Weekend
c_f_WE <- ggplot(data = merged, aes(x = RoundAge, y = SptDuration_WE_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") +
    scale_y_continuous(
    limits = c(6, 12)) + 
  labs(
    title = "Time in Bed and Age by Group Weekend (Faceted)",
    y = "Time in Bed",
    x = "Age",
    color = "Group"
  ) +
  facet_wrap(~ group)
c_f_WE
```

##Sleep Onset
```{r}
#Weekday
d_f_WD <- ggplot(data = merged, mapping = aes(x = age, y = sleeponset_WD_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(20, 28),
    breaks = seq(20, 28, by = 2)
  ) +
  labs(
    title = "Sleep Onset Age by Group Weekdays (Faceted)",
    x = "Age",
    y = "Sleep Sleep Onset (Hours, 24 is Midnight)",
    color = "Group"
  ) +
  facet_wrap(~ group)
d_f_WD

#Weekend
d_f_WE <- ggplot(data = merged, mapping = aes( x = age, y = sleeponset_WE_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(20, 28),
    breaks = seq(20, 28, by = 2)
  ) +
  labs(
    title = "Sleep Onset Age by Group Weekends (Faceted)",
    x = "Age",
    y = "Sleep Sleep Onset (Hours, 24 is Midnight)",
    color = "Group"
  ) +
  facet_wrap(~ group)
d_f_WE
```

##Sleep Wakeup
```{r}
#Weekday
e_f_WD <- ggplot(data = merged, aes(x = age, y = wakeup_WD_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") +
    scale_y_continuous(
    limits = c(28, 36),
    breaks = seq(28, 36, by = 2)
  ) +
  labs(
    title = "Sleep Wakeup and Age by Group Weekdays (Faceted)",
    y = "Sleep Wakeup (Hours)",
    x = "Age",
    color = "Group"
  ) +
  facet_wrap(~ group)
e_f_WD

#Weekend
e_f_WE <- ggplot(data = merged, aes(x = age, y = wakeup_WE_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") +
    scale_y_continuous(
    limits = c(28, 36),
    breaks = seq(28, 36, by = 2)
  ) +
  labs(
    title = "Sleep Wakeup and Age by Group Weekend (Faceted)",
    y = "Sleep Wakeup (Hours)",
    x = "Age",
    color = "Group"
  ) +
  facet_wrap(~ group)
e_f_WE
```


##WASO
```{r}
f_f_WD <- ggplot(data = merged, aes(x = age, y = WASO_WD_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") +
    scale_y_continuous(
    limits = c(0, 3),
    breaks = seq(0, 3, by = 1)
  ) +
  labs(
    title = "WASO and Age by Group Weekdays (Faceted)",
    y = "WASO",
    x = "Age",
    color = "Group"
  ) +
  facet_wrap(~ group)
f_f_WD

#weekend
f_f_WE <- ggplot(data = merged, aes(x = age, y = WASO_WE_T5A5_mn, color = group)) +
  geom_point(alpha = 0.6, size = 3) +
  geom_smooth(method = "gam", aes(group = group), se = FALSE, linetype = "solid", size = 1) +
  scale_color_brewer(palette = "Dark2") +
    scale_y_continuous(
    limits = c(0, 3),
    breaks = seq(0, 3, by = 1)
  ) +
  labs(
    title = "WASO and Age by Group Weekend (Faceted)",
    y = "WASO",
    x = "Age",
    color = "Group"
  ) +
  facet_wrap(~ group)
f_f_WE
```

#Non-Mean Exploration
```{r}
rm(list = ls())
setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
# setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git") # Home Computer
  
load("analytic-zach.RData")
Night <- read.csv("part4_nightsummary_sleep_cleaned.csv")
NightM <- read_excel("motionloggerdata.xlsx")

Night$Subject_ID <- substr(Night$filename, 1, 12)
Night$Assessment_Date <- str_extract(Night$filename, "\\d{4}-\\d{2}-\\d{2}")
Night <- Night %>% 
  filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))


bin_files_to_remove <- c(
  "8000103174_left wrist_068158_2025-06-03 10-40-36.bin",
  "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin",
  "8000156273_left wrist_060381_2024-11-05 12-27-40.bin",
  "800304581_right wrist_060843_2024-11-05 13-16-09.bin",
  "800304582__060365_2024-11-05 12-03-44.bin",
  "800304582__060365_2024-11-05 12-28-01.bin"
)

Night <- Night %>%
  filter(!filename %in% bin_files_to_remove)
Night <- Night %>%
  mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))

Night$Subject_ID <- gsub("-", "", Night$Subject_ID)
Night$Subject_ID <- gsub("[a-zA-Z]", "", Night$Subject_ID)
Night$Subject_ID <- gsub("_", "", Night$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))

setDT(Night)
setDT(FOR)

Night$geneactiv <- 1
FOR[, Assessment_Date := as.Date(assessment_date)]
FOR$Assessment_Date_FOR <- FOR$Assessment_Date
Night[, Assessment_Date := as.Date(Assessment_Date)]  # redundant if already Date
Night$Assessment_Date_Night <- Night$Assessment_Date

# Perform the join with date window logic
merged1 <- Night[FOR, on = .(Subject_ID), allow.cartesian = TRUE]

merged1[, diffdays := abs(as.numeric(difftime(Assessment_Date_Night, Assessment_Date_FOR, units = "days")))]

merged1 <- merged1 %>% filter(diffdays <= 179)

two <- merged1[(Subject_ID %in% c(8000038204, 8000114479))]


NightM <- NightM %>%
  mutate(filename = paste0(ID, "motionlogg"))

NightM$weekday <- NightM$eday
NightM <- NightM %>% 
  filter(!str_detect(Subject_ID, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))
setDT(NightM)
NightM[, Assessment_Date := as.Date(sdate)]
NightM$Assessment_date_nightM <- NightM$Assessment_Date
merged2 <- NightM[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged2[, diffdays := abs(as.numeric(difftime(Assessment_date_nightM, Assessment_Date_FOR, units = "days")))]
merged2 <- merged2 %>% filter(diffdays <= 179)
merged2$motionlogger <- 1



merged <- rbindlist(list(merged1, merged2), fill = TRUE)

#SptDuration#SptDmotionloggeruration
#sleepwakeup
#sleeponset
#WASO

#Estimated sleep efficiency
merged$SE <- (merged$SleepDurationInSpt/merged$SptDuration)*100

#Estimate Sleep Midpiont
##DOUBLE CHECK THIS CODE WORKS WELL
merged$sleeponset <- as.POSIXct(merged$sleeponset)
merged$sleepwake <- as.POSIXct(merged$sleepwake)
merged$sleep_duration <- difftime(merged$sleepwake, merged$sleeponset, units = "secs")
negative_index <- which(!is.na(merged$sleep_duration) & merged$sleep_duration < 0)
merged$sleep_duration[negative_index] <- merged$sleep_duration[negative_index] + 86400  # add 24 hours in seconds
merged$sleep_midpoint <- merged$sleeponset + (merged$sleep_duration / 2)
merged$sleep_midpoint_time <- format(merged$sleep_midpoint, "%H:%M:%S")

```


#SleepRegularity - dev
this is kind of insane rn
```{r}
merged <- merged %>%
  group_by(subject_id) %>%
  arrange(desc(time_point)) %>%
  mutate(onset_tmrw = lag(sleeponset, 1),
         wake_tmrw = lag(sleeponset, 1)) %>% ungroup()



merged <- merged %>%
  mutate(across(c(sleeponset, wakeup, onset_tmrw, wake_tmrw), as.POSIXct))



tryone <- merged %>% filter(subject_id == '8000300573')

center_minutes <- function(time_str) {
  mins <- hour(hms(time_str)) * 60 + minute(hms(time_str)) + second(hms(time_str)) / 60
  # Add 1440 if before 12:00 (720)
  mins_shifted <- ifelse(mins < 720, mins + 1440, mins)
  return(mins_shifted)
}

merged$sleeponset_minutes <- center_minutes(merged$sleeponset_ts)
merged$wakeup_minutes <- center_minutes(merged$wakeup_ts)

subject_ids <- unique(merged$subject_id)

#This needs to filter for individual actigraphy too
merged$SRI2 <- NA_real_
for (subj in subject_ids) {
  df_subj <- merged %>%
    filter(subject_id == subj) %>%
    arrange(night)
  
  actis <- unique(df_subj$filename)  # Only files for this subject
  
  for (specacti in actis) {
    df_subj_acti <- df_subj %>%
      filter(filename == specacti) %>%
      arrange(night)
    
    print(paste("Processing", subj, specacti))
    
    if (nrow(df_subj_acti) > 1) {
      for(i in 1:(nrow(df_subj_acti) - 1)) {
        day1 <- df_subj_acti[i, ]
        day2 <- df_subj_acti[i + 1, ]
        
        epoch1 <- 720:(720 + 1440 - 1)
        epoch2 <- 720:(720 + 1440 - 1)
        
      if (!is.na(day1$sleeponset_minutes) && !is.na(day1$wakeup_minutes)) {
        if(day1$sleeponset_minutes <= day1$wakeup_minutes) {
          epoch1_binary <- ifelse(epoch1 >= day1$sleeponset_minutes & epoch1 <= day1$wakeup_minutes, 1, 0)
        } else {
          epoch1_binary <- ifelse(epoch1 >= day1$sleeponset_minutes | epoch1 <= day1$wakeup_minutes, 1, 0)
        }
      } else {
        # Handle missing values — for example:
        epoch1_binary <- rep(NA, length(epoch1))
      }
      
      if (!is.na(day2$sleeponset_minutes) && !is.na(day2$wakeup_minutes)) {
        if(day2$sleeponset_minutes <= day2$wakeup_minutes) {
          epoch2_binary <- ifelse(epoch2 >= day2$sleeponset_minutes & epoch2 <= day2$wakeup_minutes, 1, 0)
        } else {
          epoch2_binary <- ifelse(epoch2 >= day2$sleeponset_minutes | epoch2 <= day2$wakeup_minutes, 1, 0)
        }
      } else {
        epoch2_binary <- rep(NA, length(epoch2))
      }
        
        valid_idx <- !is.na(epoch1_binary) & !is.na(epoch2_binary)

        if (any(valid_idx)) {
          percent_match <- mean(epoch1_binary[valid_idx] == epoch2_binary[valid_idx]) * 100
        } else {
          percent_match <- NA_real_
        }
                
        # Print days and sleep onset/wake info
        # print(paste0(
        #   "Comparing nights: ", day1$night, " vs ", day2$night, " | ",
        #   "Day1 SleepOnset: ", round(day1$sleeponset_minutes,1), " min, Wakeup: ", round(day1$wakeup_minutes,1), " min | ",
        #   "Day2 SleepOnset: ", round(day2$sleeponset_minutes,1), " min, Wakeup: ", round(day2$wakeup_minutes,1), " min | ",
        #   "Match %: ", round(percent_match, 2), "%"
        # ))
        # 
        merged_idx <- which(
          merged$subject_id == subj & 
          merged$filename == specacti & 
          merged$night == day1$night
        )
        
        merged$SRI2[merged_idx] <- percent_match
      }
    }
  }
}

merged$SRI2_scaled <- (merged$SRI2 * 2) - 100


table(merged$SRI2)

look <- merged %>% select(SleepRegularityIndex1, SRI2_scaled)

```

#Non-Mean Graphing
```{r}
merged <- merged %>%
  mutate(fhr = ifelse(group %in% c(1, 2, 3), 1, 0))


merged$fhr <- factor(merged$fhr,
                       levels = c(0, 1),
                       labels = c("Control", "FHR"))
merged$group <- factor(merged$group,
                       levels = c(0, 1, 2, 3),
                       labels = c("Control", "MDD Risk", "BD Risk", "Psy Risk"))
merged$sex <- factor(merged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
merged <- merged %>% 
  filter(!is.na(group))


merged <- merged %>%
  filter(group != 3)

unique_data <- unique(merged[, c("subject_id", "group")])

group_table <- table(unique_data$group)
pander(group_table)


unique_data <- unique(merged1[, c("subject_id", "group")])

group_table <- table(unique_data$group)
pander(group_table)

unique_data <- unique(merged2[, c("subject_id", "group")])

group_table <- table(unique_data$group)
pander(group_table)

pander(table(merged$group))
```

##Sleep Regularity Index
```{r}
a_f_WE <- ggplot(data = merged, aes(x = age, y = SRI2, color = fhr)) +
  geom_jitter(alpha = 0.3, width = 0.2, height = 0.5, size = 1.5) +
  geom_smooth(aes(group = fhr, color = as.factor(fhr)), method = "gam", se = FALSE, size = 1) +
  scale_color_brewer(palette = "Dark2") +
  scale_y_continuous(limits = c(10, 90), breaks = seq(10, 90, by = 10)) +
  labs(
    title = "Sleep Regularity Index Across Age by Group (Hex Binned + Smooth)",
    x = "Age",
    y = "Sleep Regularity Index",
    fill = "Count",
    color = "Group"
  ) 
a_f_WE
```


##Total Sleep time
###Time Spent Inactive During Sleep Window
```{r}
merged$SleepDurationInSpt <- as.numeric(merged$SleepDurationInSpt)


b_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = SleepDurationInSpt, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = fhr, color = fhr)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(4, 12),
    breaks = seq(4, 12, by = 2)
  ) +
  labs(
    title = "Sleep Duration Across Age by Group All Days (Faceted)",
    x = "Age",
    y = "Sleep Duration (Hours)",
    color = "Group"
  )  +
  theme_minimal()
b_f_WE 

ggplot(merged, aes(x = age, color = fhr, fill = fhr)) +
  geom_density(alpha = 0.4) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  labs(
    title = "Age Density by Group",
    x = "Age",
    y = "Density",
    color = "Group",
    fill = "Group"
  ) +
  theme_minimal() + facet_wrap(~ fhr)

merged$day_type <- ifelse(merged$weekday %in% c("Saturday", "Sunday", "Sat", "Sun"), "Weekend", "Weekday")
merged$day_type <- factor(merged$day_type, levels = c("Weekday", "Weekend"))

b_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = SleepDurationInSpt, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,
    aes(group = fhr, color = fhr)
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(4, 12),
    breaks = seq(4, 12, by = 2)
  ) +
  labs(
    title = "Sleep Duration Across Age by Group and Day Type",
    x = "Age",
    y = "Sleep Duration (Hours)",
    color = "Group"
  )  +
  facet_grid(day_type ~ fhr) +   # rows = day type, columns = group
  theme_minimal()
b_f_WE
```
##Sleep Efficiency
```{r}
b_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = SE, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = fhr, color = fhr)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20)
  ) +
  labs(
    title = "Sleep Efficiency Across Age by Family Risk All Days",
    x = "Age",
    y = "Sleep Efficiency",
    color = "Group"
  )  +
  theme_minimal()
b_f_WE 
```

##Sleep Midpoint

##Relative Ampitude

##Exploratory Analysis
###Extreme sleep duration
```{r}
merged <- merged %>%
  mutate(
    ideal_sleep = case_when(
      age >= 3 & age < 6 ~ 11.5,        # midpoint of 10-13 for Preschool
      age >= 6 & age <= 12 ~ 10.5,      # midpoint of 9-12 for School-age
      age > 12 & age <= 18 ~ 9,         # midpoint of 8-10 for Teen
      age > 18 ~ 7,                     # Adult: 7 or more, midpoint ~7
      TRUE ~ NA_real_                    # for ages outside these ranges
    ),
    sleep_deviation_sq = abs(SleepDurationInSpt - ideal_sleep)
  )

b_fa_WE <- ggplot(data = merged, mapping = aes(x = age, y = sleep_deviation_sq, color = group)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = group, color = group)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(0, 6),
    breaks = seq(0, 6, by = 2)
  ) +
  labs(
  title = "# Of Hours of Sleep Off Recommended",
  x = "Age",
  y = "Absolute Deviation from Recommended Sleep (hours)",
  color = "Group"
)+ theme_minimal()
b_fa_WE 

```



#power
```{r}

library(pwr)

u <- 3  # group predictors
v <- 303  #310 - 3 (group) - 3 (covariates) = 303

pwr.f2.test(u = 3, v = 303, sig.level = 0.05, power = 0.80)

pwr.t2n.test(n1=19, n2=291, d=0.2, sig.level=0.05, alternative="two.sided")

```


#Main Analysis
