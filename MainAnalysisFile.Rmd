---
title: "Trajectories"
author: "Zachary"
date: '2025-07-28'
output: html_document
---

# Library & Notes
```{r setup, include=FALSE}
library(haven); library(dplyr); library(tidyr); library(readr); library(readxl); library(data.table); library(stringr); library(purrr)  # Data manipulation & import
library(lme4); library(lmerTest); library(coxme); library(survival); library(broom); library(MuMIn); library(lsmeans)  # Modeling & statistics
library(pander); library(apaTables); library(flextable); library(officer); library(webshot2)  # Tables & reporting
library(ggplot2)  # Plotting
library(fuzzyjoin)  # Joins
library(survminer)
library(lubridate)
library(zoo)

#library(hexbin)
#library(pwr)
```

#Non-Mean Exploration
```{r}
# setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git") # Home Computer

FOR <- readr::read_csv("FOR.csv", col_types = cols(.default = col_character()))
Night <- readr::read_csv("part4_nightsummary_sleep_cleaned.csv", col_types = cols(.default = col_character()))
NightM <- read_excel("motionloggerdata.xlsx")

FOR <- FOR %>%
  mutate(
    oheightinch  = as.numeric(as.character(oheightinch)),
    oweightlb  = as.numeric(as.character(oweightlb)),
    oheightcm  = as.numeric(as.character(oheightcm)),
    oweightkg  = as.numeric(as.character(oweightkg))
  )


FOR <- FOR %>%
  mutate(oheightcm = ifelse(is.na(oheightcm), oheightinch * 2.54, oheightcm))
FOR <- FOR %>%
  mutate(oweightkg = ifelse(is.na(oweightkg), oweightlb * 0.453592, oweightkg))
FOR <- FOR %>%
  mutate(
    BMI = round(oweightkg / ((oheightcm / 100)^2), 1)
  )

FOR <- FOR %>%
    # Sort by subject and year
  group_by(subject_id) %>%
  arrange(time_point) %>%
  mutate(
    BMI_filled = BMI,  # create new BMI_filled variable
    
    BMI_filled = if_else(
      is.na(BMI_filled),
      rollapplyr(BMI_filled, width = 5, FUN = function(x) {
        # x is a vector of length 3: previous, current (NA), next
        # remove NA's and take median
        median(x[!is.na(x)], na.rm = TRUE)
      }, partial = TRUE, fill = NA),
      BMI_filled
    )
  ) %>%
  ungroup()
summary(FOR$BMI_filled)
summary(FOR$BMI)



Night$Subject_ID <- substr(Night$filename, 1, 12)
Night$Assessment_Date <- str_extract(Night$filename, "\\d{4}-\\d{2}-\\d{2}")
Night <- Night %>% 
  filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))


bin_files_to_remove <- c(
  "8000103174_left wrist_068158_2025-06-03 10-40-36.bin",
  "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin",
  "8000156273_left wrist_060381_2024-11-05 12-27-40.bin",
  "800304581_right wrist_060843_2024-11-05 13-16-09.bin",
  "800304582__060365_2024-11-05 12-03-44.bin",
  "800304582__060365_2024-11-05 12-28-01.bin"
)

Night <- Night %>%
  filter(!filename %in% bin_files_to_remove)
Night <- Night %>%
  mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))

Night$Subject_ID <- gsub("-", "", Night$Subject_ID)
Night$Subject_ID <- gsub("[a-zA-Z]", "", Night$Subject_ID)
Night$Subject_ID <- gsub("_", "", Night$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))

setDT(Night)
setDT(FOR)

Night$geneactiv <- 1
FOR[, Assessment_Date := as.Date(assessment_date)]
FOR$Assessment_Date_FOR <- FOR$Assessment_Date
Night[, Assessment_Date := as.Date(Assessment_Date)]  # redundant if already Date
Night$Assessment_Date_Night <- Night$Assessment_Date

# Perform the join with date window logic
merged1 <- Night[FOR, on = .(Subject_ID), allow.cartesian = TRUE]

merged1[, diffdays := abs(as.numeric(difftime(Assessment_Date_Night, Assessment_Date_FOR, units = "days")))]

merged1 <- merged1 %>% filter(diffdays <= 179)

two <- merged1[(Subject_ID %in% c(8000038204, 8000114479))]


NightM <- NightM %>%
  mutate(filename = paste0(ID, "motionlogg"))

NightM$weekday <- NightM$eday
NightM <- NightM %>% 
  filter(!str_detect(Subject_ID, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))
setDT(NightM)
NightM[, Assessment_Date := as.Date(sdate)]
NightM$Assessment_date_nightM <- NightM$Assessment_Date


merged2 <- NightM[FOR, on = .(Subject_ID), allow.cartesian = TRUE]


merged2[, diffdays := abs(as.numeric(difftime(Assessment_date_nightM, Assessment_Date_FOR, units = "days")))]
merged2 <- merged2 %>% filter(diffdays <= 179)
merged2$motionlogger <- 1



merged <- rbindlist(list(merged1, merged2), fill = TRUE)

#SptDuration#SptDmotionloggeruration
#sleepwakeup
#sleeponset
#WASO

#Estimated sleep efficiency
merged[, SleepDurationInSpt := as.numeric(SleepDurationInSpt)]
merged[, SptDuration := as.numeric(SptDuration)]

merged$SE <- (merged$SleepDurationInSpt/merged$SptDuration)*100

#Estimate Sleep Midpiont
##DOUBLE CHECK THIS CODE WORKS WELL
merged$sleeponset <- as.numeric(merged$sleeponset)
merged$wakeup <- as.numeric(merged$wakeup)

base_date <- as.Date("2000-01-01")
merged$sleeponset_time <- as.POSIXct(base_date) + merged$sleeponset * 3600
merged$wakeup_time     <- as.POSIXct(base_date) + merged$wakeup * 3600

merged$sleep_duration <- difftime(merged$wakeup_time, merged$sleeponset_time, units = "secs")
merged$sleep_duration[merged$sleep_duration < 0] <- merged$sleep_duration[merged$sleep_duration < 0] + 86400  
merged$sleep_midpoint <- merged$sleeponset_time + (merged$sleep_duration / 2)
merged$sleep_midpoint_time <- format(merged$sleep_midpoint, "%H:%M:%S")
```


#SleepRegularity - dev
this is kind of insane rn

Notes:
Seems to be calcultaing well, we need to ensure we are only inputting people who have good data though... and maybe double check its working!
```{r}
merged <- merged %>%
  group_by(subject_id) %>%
  arrange(desc(time_point)) %>%
  mutate(onset_tmrw = lag(sleeponset, 1),
         wake_tmrw = lag(sleeponset, 1)) %>% ungroup()



merged <- merged %>%
  mutate(across(c(sleeponset, wakeup, onset_tmrw, wake_tmrw), as.POSIXct))



tryone <- merged %>% filter(subject_id == '8000300573')



merged$time_onset <- format(merged$sleeponset_time, format = "%H:%M:%S")
merged$sleeponset_minutes <- hour(hms(merged$time_onset)) * 60 +
                             minute(hms(merged$time_onset)) +
                             second(hms(merged$time_onset)) / 60
merged$sleeponset_minutes <- merged$sleeponset_minutes + 720

merged$time_wake <- format(merged$wakeup_time, format = "%H:%M:%S")
merged$wakeup_minutes <- hour(hms(merged$time_wake)) * 60 +
                         minute(hms(merged$time_wake)) +
                         second(hms(merged$time_wake)) / 60
merged$wakeup_minutes <- merged$wakeup_minutes + 720




subject_ids <- unique(merged$subject_id)

#This needs to filter for individual actigraphy too
merged$SRI2 <- NA_real_
merged$night <- as.numeric(merged$night)

for (subj in subject_ids) {
  df_subj <- merged %>%
    filter(subject_id == subj) %>%
    arrange(night)
  
  actis <- unique(df_subj$filename)  # Only files for this subject
  
  for (specacti in actis) {
    df_subj_acti <- df_subj %>%
      filter(filename == specacti) %>%
      arrange(night)
    
    print(paste("Processing", subj, specacti))
    
    if (nrow(df_subj_acti) > 1) {
      for(i in 1:(nrow(df_subj_acti) - 1)) {
        day1 <- df_subj_acti[i, ]
        day2 <- df_subj_acti[i + 1, ]
        
        # Check if nights are consecutive
        if ((day2$night - day1$night) != 1) {
          # Not consecutive nights, skip this pair
          next
        }
        
        epoch1 <- 720:(720 + 1440 - 1)
        epoch2 <- 720:(720 + 1440 - 1)
        
        
        
        if (!is.na(day1$sleeponset_minutes) && !is.na(day1$wakeup_minutes)) {
          if(day1$sleeponset_minutes <= day1$wakeup_minutes) {
            epoch1_binary <- ifelse(epoch1 >= day1$sleeponset_minutes & epoch1 <= day1$wakeup_minutes, 1, 0)
          } else {
            epoch1_binary <- ifelse(epoch1 >= day1$sleeponset_minutes | epoch1 <= day1$wakeup_minutes, 1, 0)
          }
        } else {
          epoch1_binary <- rep(NA, length(epoch1))
        }
        
        if (!is.na(day2$sleeponset_minutes) && !is.na(day2$wakeup_minutes)) {
          if(day2$sleeponset_minutes <= day2$wakeup_minutes) {
            epoch2_binary <- ifelse(epoch2 >= day2$sleeponset_minutes & epoch2 <= day2$wakeup_minutes, 1, 0)
          } else {
            epoch2_binary <- ifelse(epoch2 >= day2$sleeponset_minutes | epoch2 <= day2$wakeup_minutes, 1, 0)
          }
        } else {
          epoch2_binary <- rep(NA, length(epoch2))
        }
        
        valid_idx <- !is.na(epoch1_binary) & !is.na(epoch2_binary)
        
        if (any(valid_idx)) {
          percent_match <- mean(epoch1_binary[valid_idx] == epoch2_binary[valid_idx]) * 100
        } else {
          percent_match <- NA_real_
        }
        
        # Print days and sleep onset/wake info
        print(paste0(
          "Comparing nights: ", day1$night, " vs ", day2$night, 
          " | Match %: ", round(percent_match, 2), "%"
        ))
        
        merged_idx <- which(
          merged$subject_id == subj & 
          merged$filename == specacti & 
          merged$night == day1$night
        )
        
        merged$SRI2[merged_idx] <- percent_match
      }
    }
  }
}



merged$SRI2_scaled <- (merged$SRI2 * 2) - 100


table(merged$SRI2)

look <- merged %>% select(SleepRegularityIndex1, SRI2_scaled)

```

#Non-Mean Graphing
```{r}
merged <- merged %>%
  mutate(fhr = ifelse(group %in% c(1, 2, 3), 1, 0))

merged$age <- as.numeric(as.character(merged$age))


merged$fhr <- factor(merged$fhr,
                       levels = c(0, 1),
                       labels = c("Control", "FHR"))
merged$group <- factor(merged$group,
                       levels = c(0, 1, 2, 3),
                       labels = c("Control", "MDD Risk", "BD Risk", "Psy Risk"))
merged$sex <- factor(merged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
merged <- merged %>% 
  filter(!is.na(group))


merged <- merged %>%
  filter(group != 3)

unique_data <- unique(merged[, c("subject_id", "group")])

group_table <- table(unique_data$group)
pander(group_table)


unique_data <- unique(merged1[, c("subject_id", "group")])

group_table <- table(unique_data$group)
pander(group_table)

unique_data <- unique(merged2[, c("subject_id", "group")])

group_table <- table(unique_data$group)
pander(group_table)

pander(table(merged$group))


merged$sleep_midpoint_time_ct <- as.POSIXct(merged$sleep_midpoint_time, format = "%H:%M:%S", tz = "UTC")
merged <- merged %>%
  mutate(fhr_num = ifelse(fhr == "FHR", 1, 0))

sum <- merged %>%
  group_by(filename) %>%
  summarise(SRI2m = mean((SRI2_scaled), na.rm=TRUE),
            TSTm = mean((SleepDurationInSpt), na.rm=TRUE),
            SEm = mean((SE), na.rm=TRUE), 
            SleepMidm = mean((sleep_midpoint_time_ct), na.rm=TRUE),
            age = mean((age), na.rm=TRUE),
            fhr = median((fhr_num), na.rm=TRUE))

sum$fhr <- factor(sum$fhr,
                       levels = c(0, 1),
                       labels = c("Control", "FHR"))

merged <- merged %>% 
  mutate(
    groupmddrisk = case_when(
      fhr == "Control" & ccMDD == 0 ~ 0,
      fhr == "FHR" & ccMDD == 0 ~ 1,
      ccMDD == 1 ~ 2,
      TRUE ~ NA_real_
    ),
    groupmddrisk = factor(
      groupmddrisk,
      levels = c(0, 1, 2),
      labels = c("Control no MDD", "FHR no MDD", "MDD diag")
    )
  )
```
##Density plot
```{r}
library(ggplot2)
library(patchwork)

# Plot 1: SRI2m
p1 <- ggplot(sum, aes(x = SRI2m)) +
  geom_density(fill = "steelblue", alpha = 0.5, color = "black") +
  scale_x_continuous(limits = c(60, 100), breaks = seq(60, 100, 10)) +
  labs(title = "SRI Mean", x = "SRI (0–100)", y = "Density") +
  theme_minimal()

# Plot 2: SE mean
p2 <- ggplot(sum, aes(x = SEm)) +
  geom_density(fill = "forestgreen", alpha = 0.5, color = "black") +
  scale_x_continuous(limits = c(70, 100), breaks = seq(70, 100, 10)) +
  labs(title = "Sleep Efficiency Mean", x = "SE (%)", y = "Density") +
  theme_minimal()

# Plot 3: TST mean
p3 <- ggplot(sum, aes(x = TSTm)) +
  geom_density(fill = "darkorange", alpha = 0.5, color = "black") +
  scale_x_continuous(limits = c(4, 12), breaks = seq(4, 12, 2)) +
  labs(title = "Total Sleep Time Mean", x = "Hours", y = "Density") +
  theme_minimal()

# Plot 4: Sleep Midpoint mean (convert to hours if POSIXct)
if (inherits(sum$SleepMidm, "POSIXt")) {
  sum$SleepMidm_hours <- as.numeric(format(sum$SleepMidm, "%H")) +
                         as.numeric(format(sum$SleepMidm, "%M")) / 60
} else {
  sum$SleepMidm_hours <- sum$SleepMidm
}

p4 <- ggplot(sum, aes(x = SleepMidm_hours)) +
  geom_density(fill = "purple", alpha = 0.5, color = "black") +
  scale_x_continuous(limits = c(0, 8), breaks = seq(0, 8, 2)) +
  labs(title = "Sleep Midpoint Mean", x = "Time of Day (hrs)", y = "Density") +
  theme_minimal()

# Combine into 2x2 layout
(p1 | p2) /
(p3 | p4)

```

##Sleep Regularity Index
```{r}
a_f_WE <- ggplot(data = merged, aes(x = age, y = SRI2_scaled, color = fhr)) +
  geom_jitter(alpha = 0.3, width = 0.2, height = 0.5, size = 1.5) +
  geom_smooth(aes(group = fhr, color = as.factor(fhr)), method = "gam", se = FALSE, size = 1) +
  scale_color_brewer(palette = "Dark2") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(-100, 100, by = 20)) +

  labs(
    title = "Sleep Regularity Index Across Age by Group (Hex Binned + Smooth)",
    x = "Age",
    y = "Sleep Regularity Index",
    fill = "Count",
    color = "Group"
  ) 
a_f_WE

a_f_WE <- ggplot(data = merged, aes(x = age, y = SRI2_scaled, color = group)) +
  geom_jitter(alpha = 0.3, width = 0.2, height = 0.5, size = 1.5) +
  geom_smooth(aes(group = group, color = as.factor(group)), method = "lm", se = FALSE, size = 1) +
  scale_color_brewer(palette = "Dark2") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(-100, 100, by = 20)) +

  labs(
    title = "Sleep Regularity Index Across Age by Group (Hex Binned + Smooth)",
    x = "Age",
    y = "Sleep Regularity Index",
    fill = "Count",
    color = "Group"
  ) 
a_f_WE

a_f_WE <- ggplot(data = sum, aes(x = age, y = SRI2m, color = fhr)) +
  geom_jitter(alpha = 0.3, width = 0.2, height = 0.5, size = 1.5) +
  geom_smooth(aes(group = fhr, color = as.factor(fhr)), method = "gam", se = FALSE, size = 1) +
  scale_color_brewer(palette = "Dark2") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(-100, 100, by = 20)) +

  labs(
    title = "Sleep Regularity Index Across Age by Group (Hex Binned + Smooth)",
    x = "Age",
    y = "Sleep Regularity Index",
    fill = "Count",
    color = "Group"
  ) 
a_f_WE


ggplot(sum, aes(x = SRI2m)) +
  geom_density(fill = "steelblue", alpha = 0.5, color = "black") +
  scale_x_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 20)) +
  labs(
    title = "Distribution of Sleep Regularity Index",
    x = "Sleep Regularity Index",
    y = "Density"
  ) +
  theme_minimal()
```


##Total Sleep time
Time Spent Inactive During Sleep Window

```{r}
merged$SleepDurationInSpt <- as.numeric(merged$SleepDurationInSpt)


b_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = SleepDurationInSpt, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = fhr, color = fhr)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(4, 12),
    breaks = seq(4, 12, by = 2)
  ) +
  labs(
    title = "Sleep Duration Across Age by Group All Days (Faceted)",
    x = "Age",
    y = "Sleep Duration (Hours)",
    color = "Group"
  )  +
  theme_minimal()
b_f_WE 

ggplot(merged, aes(x = age, color = fhr, fill = fhr)) +
  geom_density(alpha = 0.4) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  labs(
    title = "Age Density by Group",
    x = "Age",
    y = "Density",
    color = "Group",
    fill = "Group"
  ) +
  theme_minimal() + facet_wrap(~ fhr)

merged$day_type <- ifelse(merged$weekday %in% c("Saturday", "Sunday", "Sat", "Sun"), "Weekend", "Weekday")
merged$day_type <- factor(merged$day_type, levels = c("Weekday", "Weekend"))

b_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = SleepDurationInSpt, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,
    aes(group = fhr, color = fhr)
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(4, 12),
    breaks = seq(4, 12, by = 2)
  ) +
  labs(
    title = "Sleep Duration Across Age by Group and Day Type",
    x = "Age",
    y = "Sleep Duration (Hours)",
    color = "Group"
  )  +
  facet_grid(day_type ~ fhr) +   # rows = day type, columns = group
  theme_minimal()
b_f_WE


b_f_WE <- ggplot(data = sum, mapping = aes(x = age, y = TSTm, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = fhr, color = fhr)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(4, 12),
    breaks = seq(4, 12, by = 2)
  ) +
  labs(
    title = "Sleep Duration Across Age by Group All Days (Faceted)",
    x = "Age",
    y = "Sleep Duration (Hours)",
    color = "Group"
  )  +
  theme_minimal()
b_f_WE

b_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = SleepDurationInSpt, color = groupmddrisk)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = groupmddrisk, color = groupmddrisk)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_x_continuous(limits = c(8,22), breaks = seq(8, 22, by = 2)) +
  scale_y_continuous(
    limits = c(4, 12),
    breaks = seq(4, 12, by = 2)
  ) +
  labs(
    title = "Sleep Duration Across Age by Family Risk & MDD Diag",
    x = "Age",
    y = "Sleep Duration (Hours)",
    color = "Group"
  )  +
  theme_minimal()
b_f_WE 

summary(merged$groupmddrisk)
```
##Sleep Efficiency
```{r}
b_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = SE, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = fhr, color = fhr)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(0, 100),
    breaks = seq(0, 100, by = 20)
  ) +
  labs(
    title = "Sleep Efficiency Across Age by Family Risk All Days",
    x = "Age",
    y = "Sleep Efficiency",
    color = "Group"
  )  +
  theme_minimal()
b_f_WE 

b_f_WE <- ggplot(data = sum, mapping = aes(x = age, y = SEm, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = fhr, color = fhr)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(60, 100),
    breaks = seq(60, 100, by = 10)
  ) +
  labs(
    title = "Sleep Efficiency Across Age by Family Risk All Days",
    x = "Age",
    y = "Sleep Efficiency",
    color = "Group"
  )  +
  theme_minimal()
b_f_WE 
```

##Sleep Midpoint
```{r}

merged$sleep_midpoint_time_ct <- as.POSIXct(merged$sleep_midpoint_time, format = "%H:%M:%S", tz = "UTC")

b_f_WE <- ggplot(data = merged, mapping = aes(x = age, y = sleep_midpoint_time_ct, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,
    aes(group = fhr, color = fhr)
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_datetime(
    date_labels = "%H:%M",
    date_breaks = "2 hours"
  ) +
  scale_x_continuous(
  limits = c(4, 26),
  breaks = seq(4, 26, by = 2)
) +
  labs(
    title = "Sleep Midpoint Across Age by Family Risk (All Days)",
    x = "Age",
    y = "Sleep Midpoint (Time of Day)",
    color = "Group"
  ) +
  theme_minimal()

b_f_WE


b_f_WE <- ggplot(data = sum, mapping = aes(x = age, y = SleepMidm, color = fhr)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,
    aes(group = fhr, color = fhr)
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_datetime(
    date_labels = "%H:%M",
    date_breaks = "2 hours"
  ) +
  scale_x_continuous(
  limits = c(4, 26),
  breaks = seq(4, 26, by = 2)
) +
  labs(
    title = "Sleep Midpoint Across Age by Family Risk (All Days)",
    x = "Age",
    y = "Sleep Midpoint (Time of Day)",
    color = "Group"
  ) +
  theme_minimal()

b_f_WE
```

##Relative Ampitude



##Exploratory Analysis
###Extreme sleep duration
```{r}
merged <- merged %>%
  mutate(
    ideal_sleep = case_when(
      age >= 3 & age < 6 ~ 11.5,        # midpoint of 10-13 for Preschool
      age >= 6 & age <= 12 ~ 10.5,      # midpoint of 9-12 for School-age
      age > 12 & age <= 18 ~ 9,         # midpoint of 8-10 for Teen
      age > 18 ~ 7,                     # Adult: 7 or more, midpoint ~7
      TRUE ~ NA_real_                    # for ages outside these ranges
    ),
    sleep_deviation_sq = abs(SleepDurationInSpt - ideal_sleep)
  )

b_fa_WE <- ggplot(data = merged, mapping = aes(x = age, y = sleep_deviation_sq, color = group)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.5, size = 1.2) +
  geom_smooth(
    method = "gam",
    se = FALSE,
    linetype = "solid",
    size = 2,  # thicker
    aes(group = group, color = group)  # reassert color by group for clarity
  ) +
  scale_color_brewer(palette = "Dark2") + 
  scale_y_continuous(
    limits = c(0, 6),
    breaks = seq(0, 6, by = 2)
  ) +
  labs(
  title = "# Of Hours of Sleep Off Recommended",
  x = "Age",
  y = "Absolute Deviation from Recommended Sleep (hours)",
  color = "Group"
)+ theme_minimal()
b_fa_WE 

```



#power
```{r}
#112 Control
#61 At risk BP
#118 at risk MDD
#19 At risk Psychosis

##Psychosis Test
#131 - 1 - 3(covariates) - 1(dummy group variable)
library(pwr)
pwr.f2.test(u = 1, v = 126, sig.level = 0.01, power = 0.90)


##At risk MDD
pwr.f2.test(u = 1, v = 225, sig.level = 0.01, power = 0.90)

#At risk BP
pwr.f2.test(u = 1, v = 168, sig.level = 0.01, power = 0.90)

```


#Main Analysis
##Hypothesis 1: FHR is associated with differential objective sleep. 
```{r}


merged <- merged %>%
  mutate(
    mddrisk = ifelse(group == "MDD Risk", 1, 0),
    bdrisk  = ifelse(group == "BD Risk", 1, 0),
    psyrisk = ifelse(group == "Psy Risk", 1, 0)
  )


```
###TST
```{r}
# No effects
model0 <- lmer(SleepDurationInSpt ~ 1 + (1 | fid /Subject_ID / filename), data = merged, REML = FALSE)

# Add main predictors
model1 <- lmer(SleepDurationInSpt ~ mddrisk + bdrisk + psyrisk + (1 | fid /  Subject_ID / filename), data = merged, REML = FALSE)

# Add demographics: age and sex
model2 <- lmer(SleepDurationInSpt ~ mddrisk + bdrisk + psyrisk + age + sex + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Add BMI - WARNING: WE ARE MISSING PARTICIPANTS WITH BMI SCORES, IMPUTE?
model3 <- lmer(SleepDurationInSpt ~ mddrisk + bdrisk + psyrisk + age + sex + BMI + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Compare models with likelihood ratio tests
anova(model0, model1, model2)

summary(model0)
```
###SRI
```{r}
# No effects
model0 <- lmer(SRI2_scaled ~ 1 + (1 | fid /  Subject_ID / filename), data = merged, REML = FALSE)

# Add main predictors
model1 <- lmer(SRI2_scaled ~ mddrisk + bdrisk + psyrisk + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Add demographics: age and sex
model2 <- lmer(SRI2_scaled ~ mddrisk + bdrisk + psyrisk + age + sex + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Add BMI - WARNING: WE ARE MISSING PARTICIPANTS WITH BMI SCORES, IMPUTE?
model3 <- lmer(SRI2_scaled ~ mddrisk + bdrisk + psyrisk + age + sex + BMI + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Compare models with likelihood ratio tests
anova(model0, model1, model2)

summary(model2)

```


###SE
```{r}
# No effects
model0 <- lmer(SE ~ 1 + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Add main predictors
model1 <- lmer(SE ~ mddrisk + bdrisk + psyrisk + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Add demographics: age and sex
model2 <- lmer(SE ~ mddrisk + bdrisk + psyrisk + age + sex + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Add BMI - WARNING: WE ARE MISSING PARTICIPANTS WITH BMI SCORES, IMPUTE?
model3 <- lmer(SE ~ mddrisk + bdrisk + psyrisk + age + sex + BMI + (1 | fid / Subject_ID / filename), data = merged, REML = FALSE)

# Compare models with likelihood ratio tests
anova(model0, model1, model2)

summary(model2)
```
###Midpoint
```{r}
merged <- merged %>%
  mutate(
    sleep_midpoint_min = period_to_seconds(hms(as.character(sleep_midpoint_time))) / 60
  )
###Midpoint
model0 <- lmer(sleep_midpoint_min ~ 1 + (1 | Subject_ID / filename), data = merged, REML = FALSE)

# Add main predictors
model1 <- lmer(sleep_midpoint_min  ~ mddrisk + bdrisk + psyrisk + (1 | Subject_ID / filename), data = merged, REML = FALSE)

# Add demographics: age and sex
model2 <- lmer(sleep_midpoint_min ~ mddrisk + bdrisk + psyrisk + age + sex + (1 | Subject_ID / filename), data = merged, REML = FALSE)

# Add BMI - WARNING: WE ARE MISSING PARTICIPANTS WITH BMI SCORES, IMPUTE?
model3 <- lmer(sleep_midpoint_min  ~ mddrisk + bdrisk + psyrisk + age + sex + BMI + (1 | Subject_ID / filename), data = merged, REML = FALSE)

# Compare models with likelihood ratio tests
anova(model0, model1, model2)

summary(model3)
```


##Hypothesis 2: Trajectories  
```{r}
merged <- merged %>% filter(age >= 8 & age <= 22)
merged <- merged %>% filter(group != 'Psy Risk')

table(merged$group)

# Create weekend variable: 1 for Saturday/Sunday, 0 otherwise
merged$weekend <- ifelse(merged$weekday %in% 
                         c("Sat", "Saturday", "Sun", "Sunday"), 1, 0)

# Check result
table(merged$weekend, merged$weekday)

```

###TST
```{r}
library(mgcv)
library(gratia)    # For difference_smooths() and draw()
library(ggplot2)
library(dplyr)
library(gamm4)


#Model Testing 
merged$subject_id <- as.factor(merged$subject_id)

#Just subject_id intercept and adding filename
model1 <- lmer(SleepDurationInSpt ~ fhr + sex + ccMDD + age + (1|subject_id ), data = merged)
model2 <- lmer(SleepDurationInSpt ~ fhr + sex + ccMDD + age + (1|subject_id / filename), data = merged)
anova(model1, model2)

#Adding fid to interept
model3 <- lmer(SleepDurationInSpt ~ fhr + sex + ccMDD + age + (1| fid/subject_id / filename), data = merged)
anova(model2, model3)

vc <- as.data.frame(VarCorr(model3))
var_fixed <- var(as.vector(fixef(model3) %*% t(model.matrix(model3)[, names(fixef(model3))])))
var_random <- sum(vc$vcov[vc$grp != "Residual"])
var_resid  <- vc$vcov[vc$grp == "Residual"]

R2m <- var_fixed / (var_fixed + var_random + var_resid)
R2c <- (var_fixed + var_random) / (var_fixed + var_random + var_resid)

c(marginal = R2m, conditional = R2c)



#Comparing a linear to nonlinear model


merged2 <- merged[!is.na(merged$BMI_filled), ]
linear <- gamm4(SleepDurationInSpt ~ fhr*age + sex,
                   random = ~(1 | fid / subject_id / filename),
                   data = merged)

nonlinear <- gamm4(SleepDurationInSpt ~ fhr + sex + s(age, by = fhr, k = 5),
                   random = ~(1 | fid/ subject_id / filename),
                   data = merged)
summary(nonlinear$gam)

#Extract merMod objects
linear_ml <- linear$mer
nonlinear_ml <- nonlinear$mer
anova(linear_ml, nonlinear_ml)



gam.check(nonlinear$gam)

summary(nonlinear$gam)
```

####Graph
```{r}
# 3. Calculate difference smooth between groups
diff <- difference_smooths(nonlinear$gam,
                           select = "s(age)",
                           by = "fhr",
                           comp = list(fhr = c("FHR", "Control")))


# 4. Plot difference smooth (shows where groups differ)
draw(diff)


# 5. Create predicted trajectories by group for ggplot

# Create new data for prediction (age sequence)
age_seq <- seq(min(merged$age), max(merged$age), length.out = 200)

# Create a new data frame with average covariate values
newdat <- expand.grid(
  age = age_seq,
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex))  # character matching merged$ccMDD values
)

newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
newdat$se <- pred$se.fit
newdat <- newdat %>%
  mutate(
    lower = fit - 2 * se,
    upper = fit + 2 * se
  )

# 6. Plot adjusted smooths for groups with ggplot

ggplot(newdat, aes(x = age, y = fit, color = fhr)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = fhr), alpha = 0.2, color = NA) +
  scale_y_continuous(limits = c(2, 12), breaks = seq(2, 12, by = 2)) +
scale_color_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
scale_fill_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +

  labs(title = "Adjusted Sleep Duration Trajectories by Group",
       x = "Age",
       y = "Predicted Sleep Duration (hours)",
       color = "Group",
       fill = "Group") +
  theme_minimal()
```
####Illustae time in bed
```{r}


library(lubridate)

# Convert to seconds since midnight
onset_sec  <- hour(merged$sleeponset_time) * 3600 +
              minute(merged$sleeponset_time) * 60 +
              second(merged$sleeponset_time)

wakeup_sec <- hour(merged$wakeup_time) * 3600 +
              minute(merged$wakeup_time) * 60 +
              second(merged$wakeup_time)

# Duration in hours, wrap around midnight automatically
merged$SptDuration_hours <- ((wakeup_sec - onset_sec) %% (24 * 3600)) / 3600

summary(merged$SptDuration_hours)
merged$sleepwindow <- as.numeric(merged$guider_SptDuration)
nonlinear <- gamm4(SptDuration_hours ~ fhr + sex + ccMDD + s(age, by = fhr),
                   random = ~(1 | fid/ subject_id / filename),
                   data = merged)

#Extract merMod objects
nonlinear_ml <- nonlinear$mer

gam.check(nonlinear$gam)


# 3. Calculate difference smooth between groups
diff <- difference_smooths(nonlinear$gam,
                           select = "s(age)",
                           by = "fhr",
                           comp = list(fhr = c("FHR", "Control")))


# 4. Plot difference smooth (shows where groups differ)
draw(diff)


# 5. Create predicted trajectories by group for ggplot

# Create new data for prediction (age sequence)
age_seq <- seq(min(merged$age), max(merged$age), length.out = 200)

# Create a new data frame with average covariate values
newdat <- expand.grid(
  age = age_seq,
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex)),
  ccMDD = "0"  # character matching merged$ccMDD values
)

newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
newdat$se <- pred$se.fit
newdat <- newdat %>%
  mutate(
    lower = fit - 2 * se,
    upper = fit + 2 * se
  )

# 6. Plot adjusted smooths for groups with ggplot

ggplot(newdat, aes(x = age, y = fit, color = fhr)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = fhr), alpha = 0.2, color = NA) +
  scale_y_continuous(limits = c(2, 12), breaks = seq(2, 12, by = 2)) +
scale_color_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
scale_fill_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +

  labs(title = "Adjusted Sleep Duration Trajectories by Group",
       x = "Age",
       y = "Predicted Sleep Duration (hours)",
       color = "Group",
       fill = "Group") +
  theme_minimal()

```


###SRI
Ceiling effect, most of our participants have very high SRI.    
```{r}
#Model Testing 
merged$subject_id <- as.factor(merged$subject_id)

#Just subject_id intercept and adding filename
model1 <- lmer(SRI2_scaled ~ fhr + sex + ccMDD + age + (1|subject_id ), data = merged)
model2 <- lmer(SRI2_scaled ~ fhr + sex + ccMDD +  age + (1|subject_id / filename), data = merged)
anova(model1, model2)

#Adding fid to interept
model3 <- lmer(SRI2_scaled ~ fhr*age + sex + ccMDD +  (1| fid /subject_id / filename), data = merged)
anova(model2, model3)
model4 <- lmer(SRI2_scaled ~ fhr *age + sex + ccMDD + weekend + (1| fid /subject_id / filename), data = merged2)
anova(model4, model5)
model5 <- lmer(SRI2_scaled ~ fhr *age + sex + ccMDD + weekend + BMI + (1| fid /subject_id / filename), data = merged2)


#Comparing a linear to nonlinear model
linear <- gamm4(sqrt(SRI2_scaled) ~ fhr*age + sex + weekend,
                   random = ~(1 | fid / subject_id / filename),
                   data = merged)




nonlinear <- gamm4(SRI2_scaled ~ fhr + sex + weekend + s(age, by = fhr),
                   random = ~(1 | fid/ subject_id / filename),
                   data = merged)


gam.check(nonlinear$gam)


linear_ml <- linear$mer
nonlinear_ml <- nonlinear$mer
anova(linear_ml, nonlinear_ml)

summary(linear$gam)
summary(nonlinear$gam)






library(gamm4)
library(gratia)

library(mgcv)
merged$subject_id <- as.factor(merged$subject_id)



diff <- difference_smooths(nonlinear$gam, smooth = "s(age)", by = "fhr",
                           comp = list(fhr = c("FHR", "Control")))
draw(diff)



age_seq <- seq(min(merged$age), max(merged$age), length.out = 200)

newdat <- expand.grid(
  age = age_seq,
  fhr = c("Control", "FHR"),
  sex = "Female",        # same level as in your model
  weekend = 0            # numeric
)


newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
newdat$se <- pred$se.fit
newdat <- newdat %>%
  mutate(
    lower = fit - 2 * se,
    upper = fit + 2 * se
  )

# 6. Plot adjusted smooths for groups with ggplot

ggplot(newdat, aes(x = age, y = fit, color = fhr)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = fhr), alpha = 0.2, color = NA) +
  scale_y_continuous(limits = c(60,100), breaks = seq(60,100, by = 10)) +
scale_color_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
scale_fill_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +

  labs(title = "Adjusted Sleep Regularity Trajectories by Group",
       x = "Age",
       y = "Predicted Sleep Regularity",
       color = "Group",
       fill = "Group") +
  theme_minimal()
```
notes: Deciding age range, deciding metric for model comparisons, choose a criteria that you can defend. 

Add in 3 groups: Controls w/o dep, FHR w/o dep, those with depression (look at this trajectory)
- Is adding this as a covariate controlling or not since it has dif interactions at different ages. 
- 


###SE
```{r}
#Model Testing 
merged$subject_id <- as.factor(merged$subject_id)

#Just subject_id intercept and adding filename
model1 <- lmer(SE ~ fhr + sex + ccMDD + age + (1|subject_id ), data = merged)
model2 <- lmer(SE ~ fhr + sex + ccMDD +  age + (1|subject_id / filename), data = merged)
anova(model1, model2)

#Adding fid to interept
model3 <- lmer(SE ~ fhr + sex + ccMDD + age + (1| fid /subject_id / filename), data = merged)
anova(model2, model3)

model3 <- lmer(SE ~ fhr*age +  sex + (1| fid/subject_id / filename), data = merged2)

model4 <- lmer(SE ~ fhr*age +  sex + BMI_filled + (1| fid/subject_id / filename), data = merged2)
anova(model3, model4)


#Comparing a linear to nonlinear model
linear <- gamm4(SE ~ fhr*age + BMI_filled + sex,
                   random = ~(1 | fid / subject_id / filename),
                   data = merged2)

nonlinear <- gamm4(SE ~ s(age, by = fhr) + fhr + BMI_filled + sex ,
                   random = ~(1 | fid/ subject_id / filename),
                   data = merged2)



linear_ml <- linear$mer
nonlinear_ml <- nonlinear$mer
anova(linear_ml, nonlinear_ml)

summary(nonlinear$gam)
summary(linear$gam)

gam.check(nonlinear$gam)






library(gamm4)
library(gratia)

library(mgcv)
merged$subject_id <- as.factor(merged$subject_id)


gam_model <- gam(SE ~ fhr + sex + ccMDD +
                   s(age, by = fhr, k = 10) +
                   s(subject_id, bs = "re"),
                 data = merged, method = "REML")
gam.check(gam_model)

diff <- difference_smooths(nonlinear$gam, smooth = "s(age)", by = "fhr",
                           comp = list(fhr = c("FHR", "Control")))
draw(diff)



age_seq <- seq(min(merged$age), max(merged$age), length.out = 200)
bmi_seq <- seq(
  from = min(merged$BMI_filled, na.rm = TRUE),
  to   = max(merged$BMI_filled, na.rm = TRUE),
  length.out = 200
)


# Create a new data frame with average covariate values
newdat <- expand.grid(
  age = age_seq,
  BMI_filled = median(merged$BMI_filled, na.rm = TRUE),
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex))
)

newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
newdat$se <- pred$se.fit
newdat <- newdat %>%
  mutate(
    lower = fit - 2 * se,
    upper = fit + 2 * se
  )

# 6. Plot adjusted smooths for groups with ggplot

ggplot(newdat, aes(x = age, y = fit, color = fhr)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = fhr), alpha = 0.2, color = NA) +
  scale_y_continuous(limits = c(60,100), breaks = seq(60,100, by = 20)) +
scale_color_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
scale_fill_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +

  labs(title = "Adjusted Sleep Efficiency Trajectories by Group",
       x = "Age",
       y = "Predicted Sleep Efficiency",
       color = "Group",
       fill = "Group") +
  theme_minimal()
```

###Midpoint
```{r}
merged2 <- merged %>%
  filter(!is.na(BMI_filled))

model3 <- lmer(SleepDurationInSpt ~ fhr*age +  sex + (1| fid/subject_id / filename), data = merged2)

model4 <- lmer(SleepDurationInSpt ~ fhr*age +  sex + BMI_filled + (1| fid/subject_id / filename), data = merged2)
anova(model3, model4)

linear <- gamm4(sleep_midpoint_min ~ fhr*age + sex,
                   random = ~(1 | fid / subject_id / filename),
                   data = merged)

nonlinear <- gamm4(sleep_midpoint_min ~ fhr + sex + s(age, by = fhr),
                   random = ~(1 | fid/ subject_id / filename),
                   data = merged)



linear_ml <- linear$mer
nonlinear_ml <- nonlinear$mer
anova(linear_ml, nonlinear_ml)

summary(linear$gam)
summary(nonlinear$gam)




gam.check(nonlinear$gam)


diff <- difference_smooths(nonlinear$gam, smooth = "s(age)", by = "fhr",
                           comp = list(fhr = c("FHR", "Control")))
draw(diff)



age_seq <- seq(min(merged$age), max(merged$age), length.out = 200)

# Create a new data frame with average covariate values
newdat <- expand.grid(
  age = age_seq,
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex))
)

newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
newdat$se <- pred$se.fit
newdat <- newdat %>%
  mutate(
    lower = fit - 2 * se,
    upper = fit + 2 * se
  )

# 6. Plot adjusted smooths for groups with ggplot

ggplot(newdat, aes(x = age, y = fit/60, color = fhr)) +   # convert to hours
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = lower/60, ymax = upper/60, fill = fhr), alpha = 0.2, color = NA) +
  scale_color_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
  scale_fill_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
  scale_y_continuous(
    breaks = seq(0, 24, by = 2),   # ticks every 2 hours
    labels = function(x) sprintf("%02d:00", x %% 24)  # format as HH:00
  ) +
  labs(title = "Sleep Midpoint Trajectories by Group",
       x = "Age",
       y = "Predicted Sleep Midpoint (hours)",
       color = "Group",
       fill = "Group") +
  theme_minimal()
```


#CSV
```{r}
# Load into a temporary environment to avoid corrupting your global one
setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
temp_env <- new.env()
load("analytic-zach.RData", envir = temp_env)

# List all objects
all_objs <- ls(temp_env)

# Save each data frame to CSV
for (obj_name in all_objs) {
  obj <- get(obj_name, envir = temp_env)
  
  if (is.data.frame(obj)) {
    # Construct a filename
    filename <- paste0(obj_name, ".csv")
    
    # Write to CSV
    write.csv(obj, file = filename, row.names = FALSE)
    
    message("Saved: ", filename)
  } else {
    message("Skipped (not a data frame): ", obj_name)
  }
}

```


##TST
```{r}
model1 <- lmer(SleepDurationInSpt ~ age + sex + bmi + groupmdd + grouppsy + groupbp + (1|subject_id) + (1|filename) + (1|subject_id), data = merged)
```

